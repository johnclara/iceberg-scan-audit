@Library("jenkins-pipeline-library") _

VERSION_SNAPSHOT = '0.0.0-SNAPSHOT'
VERSION_RELEASE = '0.0.0'

def getVersion() {
    return sh(script: "grep version= gradle.properties | cut -d '=' -f2 | cut -d '-' -f1", returnStdout: true).trim()
}

pipeline {
  agent {
    label 'skynet'
  }
  stages {
    stage('Get version number') {
      steps {
        script {
          VERSION = getVersion().toString()
          if (!VERSION_SNAPSHOT.endsWith("-SNAPSHOT")) {
            error "Expected version.sbt to contain a version that ends with '-SNAPSHOT' suffix"
          }
          VERSION_SNAPSHOT = VERSION+"-SNAPSHOT"
          VERSION_RELEASE = VERSION+"-RELEASE"
          echo "VERSION_SNAPSHOT=${VERSION_SNAPSHOT}"
          echo "VERSION_RELEASE=${VERSION_RELEASE}"
        }
      }
    }
    stage('Cut release') {
      steps {
        script {
          sh('sh cut-release.sh')
        }
      }
    }
    stage('Publish to Artifactory') {
      steps {
        script {
          build job: "ArtifactSigning/gradle-native-sign-publish-homegrown-artifacts", parameters: [
            [$class: 'StringParameterValue',
            name  : 'git_repo',
            value : "git@git.dev.box.net:DataPlatform/data-platform-iceberg.git"],
            [$class: 'StringParameterValue',
            name  : 'branch',
            value : VERSION_RELEASE],
            [$class: 'StringParameterValue',
            name  : 'gradle_root',
            value : "."],
            [$class: 'StringParameterValue',
            name  : 'javaVersion',
            value : "8"],
          ]
        }
      }
    }
  }
}
